server {
    listen 4321;
    server_name _;

    # =========================================================
    # 1. NODE-RED (พระเอกหลัก - เข้าผ่านหน้าแรก)
    # =========================================================
    location / {
        # ต้องใช้ชื่อ Container ให้ตรงกับใน docker-compose (nodered-emqx)
        proxy_pass http://nodered-emqx:1880;

        # ตั้งค่า WebSocket (สำคัญมากสำหรับ Node-RED)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # ส่งค่า IP จริงไปให้ Node-RED (มีประโยชน์ตอนดู Audit Log)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================
    # 2. Node-RED Dashboard (เผื่อคุณใช้ Dashboard UI)
    # =========================================================
    location /ui/ {
        proxy_pass http://nodered-emqx:1880/ui/;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # =========================================================
    # 3. EMQX Dashboard (หน้าจัดการ MQTT)
    # =========================================================
    # หมายเหตุ: EMQX Dashboard มักจะมีปัญหาถ้าไม่ได้อยู่ที่หน้าแรก (/)
    # ถ้าเข้าผ่าน /emqx/ แล้วหน้าขาว ให้เปลี่ยนไปใช้วิธี Forward Port แทน
    location /emqx/ {
        proxy_pass http://emqx:18083/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # =========================================================
    # 4. MQTT over WebSocket (สำหรับ Web Client)
    # =========================================================
    # อันนี้มีประโยชน์มาก ถ้าคุณจะเขียนเว็บเองให้ต่อ MQTT ผ่านบราวเซอร์
    location /mqtt {
        proxy_pass http://emqx:8083/mqtt;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
